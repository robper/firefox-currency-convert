# Todo

V3
Darkmode popup

# Usage 

1. Click the icon on the browser toolbar to select currency to convert to.
2. Mark some text on a website ex, USD 450.00
3. Right click
4. Select Convert to {currency}

Must text formatted according to ISO 4217 using a valid [Decimal Separator](https://en.wikipedia.org/wiki/Decimal_separator) should work.

# Code 

background.js: background script, pickup events etc  
content.js: "frontend", can manipulate webpages  
popup.html: toolbar button  

Background script downloads conversion rates from a [Exchangerate-API](https://www.exchangerate-api.com/docs/free)for the selected target currency and stores it into the browsers local storage.
This data is updated if the target currency is changed, OR if the current date-time exceeds the next update time (included in the data).

When the user selects some text and click the context menu button, the background script identifies which currency it represents(if any), fetches the exchange rates from the storage, and calculates the value in the selected currency.

The content script displays this value on the webpage right below the marked text.

## Toolbar / settings / popup

The selectable target currencies are loaded from the data in the browser storage, this data 'should' always exist because it's loaded when the addon is started. However if this should fail, or if the user manually clears the storage, some defaults are provided which can be used to generate new data and repopulate the list with all available currencies.

## Tests

Automated tests using vitest, see comments in background.js and ./tests.

A lot of tests are redundant, duplicates or autogenerated. I just wanted lots of them since most of the code for identifying the marked text are AI-generated and it was impossible to know if it did anything correctly without them.

No tests for: 
- Outdated exchange rates
- Changing of target currency

Reason is I found it easy to test manually, and it kinda worked on the first try.

Testing updating outdated exchange rates should be easy, load a file with an old date in the browser mock before starting the test. This should automatically run a fetch for new data when the target currency is loaded. So... this is probably done already, I just don't check if it's actually updated, but if it didn't work it would've thrown an error.

Testing for changing target currency would be to set the target currency inside a test, like so:
```js
browser.storage.local.set({
    targetCurrency: targetCurrencySelect.value
});
```
then checking the storage which base_currency is there

### Browser mock

For certain tests we need to mock the browsers behaviour, this mock returns some hard coded values for tabs and IDs just to stop the calls complaining. Some functions, like storage, are "fully working" with some in-memory database i.e. a map.


## APIs
Current: https://www.exchangerate-api.com/docs/free free and no API key  
Alternatives  
Swedish Riksbanken: https://developer.api.riksbank.se/api-details#api=swea-api
FXRates: https://fxratesapi.com/ 1k/m√•nad  
Can only do 1 conversion at a time, file with all conversions for one currency: https://hexarate.paikama.co/